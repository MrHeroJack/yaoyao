## 项目现状与目标
- 技术栈：React + Vite，纯前端，无后端与真实上传逻辑；管理员模式与图片“链接添加”已存在。
- 目标：在保持现有功能与数据结构的前提下，新增管理员图片上传与管理（含断点续传、批量、校验、进度、预览），并完成可爱风格 +《疯狂动物城》主题视觉改造，补充完整测试与文档。

## 架构调整
- 新增后端轻服务（Node.js + Express/Koa）用于云存储签名与对象管理：`server/`。
  - 环境变量管理：`.env`（仅服务器持有密钥）；前端使用无敏感信息的公开配置。
  - 提供统一 REST API：`/api/storage/providers`、`/api/upload/qiniu/token`、`/api/upload/oss/sts`、`/api/images`（list）、`DELETE /api/images/:key`。
- 前端抽象存储适配层：`src/admin/storage/`。
  - `IStorageProvider` 接口（上传、取消、恢复、列表、删除）。
  - `QiniuProvider`（基于 `qiniu-js`，使用后端签发 `uploadToken`，原生分片与断点续传）。
  - `OSSProvider`（基于 `ali-oss`，使用 STS/Policy，`multipartUpload` + checkpoint 断点续传）。
- 配置与兼容：`src/config/storage.ts` 读取 `VITE_STORAGE_PROVIDER`，默认 `link-only`，保持旧链接模式；切换为 `qiniu`/`oss` 时启用上传模块。

## 管理员模块增强（前端）
- 目录与组件：`src/admin/`
  - `ImageUploader`：文件选择（multiple）、格式与大小校验、上传进度（单文件/总体）、暂停/恢复/取消、失败重试。
  - `UploadQueue`：队列与并发控制（建议并发 3），错误与重试策略。
  - `ImageManager`：缩略图网格、预览大图、批量选择、删除、标签/备注（与现有事件图片结构兼容）。
  - `useUpload` Hook：封装上传状态、断点信息存储（IndexedDB/localStorage 的 checkpoint）。
- 数据衔接：上传成功后返回可访问 URL，沿用现有 `ImageItem` 并插入到事件图片集合；保留“添加图片链接”入口以兼容旧流程。
- 校验与提示：
  - 格式：`image/jpeg`、`image/png`、`image/gif`。
  - 大小：单文件 ≤ 5MB（可通过配置调整）。
  - 进度：每文件进度条 + 总体进度，支持上传速率与剩余时间估算。

## 存储与断点续传实现要点
- Qiniu：
  - 后端生成 `uploadToken`（Scope/Deadline/Policy），前端用 `qiniu-js` 的分片上传，`resumeRecords` 本地存储实现断点续传。
  - 命名方案：`uploads/${yyyy}/${mm}/${uuid}.${ext}`；可选自定义前缀。
- OSS：
  - 后端返回 STS 或使用后端生成的 `multipart` 授权，前端 `ali-oss` 的 `multipartUpload(file, { progress, checkpoint })`。
  - 断点记录保存与恢复：`checkpoint` 持久化到 IndexedDB/localStorage。
- 列表与删除：统一经后端代理（避免暴露密钥），支持按前缀分页列举与批量删除。

## 视觉风格改造
- 设计规范与主题：
  - 新增 `src/styles/theme.css`（CSS 变量）：色板（柔和粉、薄荷绿、天空蓝、暖黄）、圆角（8/12/16px）、阴影、动效时长（150/250ms）。
  - 构建 `CuteTheme` 的 `ThemeProvider`（可选），或保持 CSS 变量全局方案以降低迁移成本。
- 组件风格：
  - 按钮、输入框、卡片统一圆角与阴影；过渡与缩放动效（ease-out）。
  - 列表与网格采用更大留白与柔和分隔线。
- 《疯狂动物城》主题元素：
  - 头像占位与图标：使用角色风格化插画或公有授权素材；预留替换接口与占位图。
  - 背景：提供可切换的主题背景（轻纹理/低饱和场景图），注意版权与图片体积。
  - 配色：参考影片主色调，转化为低对比度可读配色方案，沉浸但不影响信息识别。

## 向后兼容策略
- 保留“图片链接添加”流程与现有 `ImageItem` 字段；上传成功后仅追加 URL。
- 对旧数据无迁移需求；新增字段（如 `provider`, `key`）均为可选。
- 样式以 CSS 变量为主，未覆盖的旧样式保持原样；逐步替换。

## 测试与质量保障
- 单元与组件测试：引入 `vitest` + `@testing-library/react`；覆盖上传校验、进度显示、状态变更。
- 集成测试：模拟后端签名接口（Mock Service Worker），验证 Qiniu/OSS 适配层行为与失败重试。
- 端到端测试：`playwright`（无头浏览器）覆盖管理员登录、批量上传、预览与删除。
- 性能测试：
  - 上传并发与网络限速场景（3G/4G），记录平均耗时与失败率。
  - UI 性能（切换、滚动、预览）与 Lighthouse/ Web Vitals 采样。
- 测试报告：自动生成覆盖率（`c8`）、E2E 截图与时序数据，形成 `docs/test-report.md`。

## 文档与交付物
- 设计规范文档：`docs/design-guidelines.md`（色板、半径、动效、组件样式示例、主题资源来源与版权说明）。
- API 文档：`docs/api.md`（签名/上传/列表/删除接口、请求与响应、错误码、示例）。
- 重构代码：前后端可运行项目，`.env.example` 提供变量清单；默认使用 `link-only` 模式可直接运行前端。
- 测试报告：功能测试与性能测试结果、覆盖率与关键截图。

## 实施步骤（里程碑）
1) 后端签名服务与对象管理（Qiniu/OSS），本地 `.env` 与安全基线。
2) 前端存储适配层与 `ImageUploader` + `UploadQueue`，打通上传与断点续传。
3) `ImageManager` 列表、预览、删除与事件数据衔接，保留旧链接入口。
4) 视觉主题落地（CSS 变量与关键组件改造），加入主题资源占位。
5) 测试体系搭建与用例覆盖，生成测试报告与性能数据。
6) 完整文档编写与交付检查，保证可运行与向后兼容。

## 风险与注意事项
- 安全：密钥仅在后端持有；前端使用短时签名/STS；避免将敏感信息写入仓库。
- 版权：主题素材需使用授权或自制占位；文档注明来源与许可。
- 体积与性能：图片压缩与懒加载；并发与重试策略可配置；移动端体验优先。
- 备用方案：若云服务不可用，自动回退为“链接添加”模式，保证功能可用。